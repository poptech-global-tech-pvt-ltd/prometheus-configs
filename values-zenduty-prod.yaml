alertmanager:
  config:
    global:
      resolve_timeout: 15m
    route:
      group_by: ['...']
      group_wait: 1s
      group_interval: 30s
      repeat_interval: 1m
      receiver: 'zenduty'
      routes:
        - match:
            team: "devops"
          receiver: 'zenduty-team-devops'
        - match:
            team: "cx"
          receiver: 'cx'
        - match:
            team: "cx"
          receiver: 'cx'
        - match:
            team: "jiva"
          receiver: 'jiva'
        - match:
            team: "jiva"
          receiver: 'loyaltyscan'
        - match:
            team: "popcoins"
          receiver: 'popcoins'
        - match:
            team: "publicappremix"
          receiver: 'publicappremix'
        - match:
            team: "rcbp"
          receiver: 'rcbp'
        - match:
            team: "shop"
          receiver: 'shop'
        - match:
            team: "search"
          receiver: 'search'
        - match:
            team: "upi"
          receiver: 'upi' 
    receivers:
      - name: 'zenduty'
        webhook_configs:
          - url: 'https://events.zenduty.com/integration/vp8fc/prometheus/80886b84-dc6d-416a-8e88-99217c46d282/'
      - name: 'zenduty-team-devops'
        webhook_configs:
          - url: 'https://events.zenduty.com/integration/vp8fc/prometheus/187034b2-e981-4e04-b0cc-b0d0068818ff/'
      - name: 'cx'
        webhook_configs:
          - url: 'https://events.zenduty.com/integration/vp8fc/prometheus/958f3010-85de-4056-975d-b6ba402b1c37/'
      - name: 'jiva'
        webhook_configs:
          - url: 'https://events.zenduty.com/integration/vp8fc/prometheus/0b3bea36-a61d-4a72-9fc9-7d5f6c5dbde7/'
      - name: 'loyaltyscan'
        webhook_configs:
          - url: 'https://events.zenduty.com/integration/vp8fc/prometheus/bbd22876-b882-494e-80a9-b6ba58d7c079/'
      - name: 'popcoins'
        webhook_configs:
          - url: 'https://events.zenduty.com/integration/vp8fc/prometheus/20d9c9ee-a281-4bf8-91a5-40530a002764/'
      - name: 'publicappremix'
        webhook_configs:
          - url: 'https://events.zenduty.com/integration/vp8fc/prometheus/13f462a5-c35f-4dab-a7ef-a4c6e4590619/'
      - name: 'rcbp'
        webhook_configs:
          - url: 'https://events.zenduty.com/integration/vp8fc/prometheus/20860cce-abac-433c-88b5-24540ade4c86/'
      - name: 'shop'
        webhook_configs:
          - url: 'https://events.zenduty.com/integration/vp8fc/prometheus/4f15377b-9d59-456c-b5a4-8ae5281e5ba5/'
      - name: 'search'
        webhook_configs:
          - url: 'https://events.zenduty.com/integration/vp8fc/prometheus/67ef993e-3bf0-40e7-94c0-def660628a03/'
      - name: 'upi'
        webhook_configs:
          - url: 'https://events.zenduty.com/integration/vp8fc/prometheus/e6ce6457-a049-42cc-a992-fcfd5a9728d5/'
      - name: 'upi'
        webhook_configs:
          - url: 'https://events.zenduty.com/integration/vp8fc/prometheus/e6ce6457-a049-42cc-a992-fcfd5a9728d5/'
      
      
server:
  persistentVolume:
    size: 250Gi
serverFiles:
  prometheus.yml:
    scrape_configs:
      - job_name: 'yace'
        metrics_path: /metrics
        static_configs:
          - targets: ['yace-yet-another-cloudwatch-exporter:80']
      - job_name: 'blackbox'
        metrics_path: /probe
        params:
          module: [http_exact_200]
        static_configs:
          - targets:
              - http://jiva.popclub.co.in/api/ext/v1/coins/txn
        relabel_configs:
          - source_labels: [__address__]
            target_label: __param_target
          - source_labels: [__param_target]
            target_label: instance
          - target_label: __address__
            replacement: black-prometheus-blackbox-exporter:9115  # Your blackbox exporter address
        scrape_interval: 30s
      - job_name: 'kube-state-metrics'
        static_configs:
          - targets: ['prometheus-kube-state-metrics.prometheus-pop-prod.svc.cluster.local:8080']
      # - job_name: 'AllClusterServices'
      #   kubernetes_sd_configs:
      #     - role: service
      - job_name: 'ClusterServices'
        metrics_path: /metrics
        static_configs:
          - targets: ['jiva-svc.pop-prod.svc.cluster.local:80', 
                      'seller-report-engine.pop-prod.svc.cluster.local:80',
                      'pop-payments-svc.pop-prod.svc.cluster.local:80',
                      'prometheus-server.prometheus-pop-prod.svc.cluster.local:80',
                      'opentelemetry-operator.kubesense.svc.cluster.local:8080',
                      'presentation-layer.pop-prod.svc:80',
                      'prometheus-lb.prometheus-pop-prod.svc:80',
                      'kubesense-kube-state-metrics.kubesense.svc:8080',
                      'kubesense-datastore.kubesense.svc:8001',
                      'grafana.prometheus-pop-prod.svc:80',
                      'cloudwatch-exporter.prometheus-pop-prod.svc:9106',
                      'seller-report-engine.pop-prod.svc:80',
                      'kubesense-metrics-store.kubesense.svc:8428',
                      'kubesense-metrics-scraper.kubesense.svc:30060',
                      'prometheus-kube-state-metrics.prometheus-pop-prod.svc:8080',
                      'popupigo-sit.popclub.co.in',
                      'userprofile-sit.popclub.co.in',
                      'cardlegacy-sit.popclub.co.in',
                      'nidhi-sit.popclub.co.in',
                      'hashira-sit.popclub.co.in',
                      'eventcomms.popclub.co.in',
                      'sherlock-sit.popclub.co.in',
                      'api.getpopcard.co',
                      'cassa-sit.popclub.co.in'
                      ]
  alerting_rules.yml:
    groups:
      - name: UnhealthyK8sInfra
        rules:
          - alert: Deployment0PodsReady
            expr: kube_deployment_spec_replicas{namespace="pop-prod", deployment!="popbe-preprod"} > 0 and kube_deployment_status_replicas_available{namespace="pop-prod", deployment!="popbe-preprod"} == 0
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: "Service Is Unhealthy!"
              description: "The deployment desires {{ $value }} replicas but has 0 ready. This may indicate a rollout failure, pod crashes, or resource issues."
      - name: UnhealthyServices
        rules:
          - alert: ServiceUnhealthy
            expr: up == 0
            for: 1m
            labels:
              severity: critical
            annotations:
              summary: "Service {{ $labels.instance}} is unhealthy"
              description: "Service {{ $labels.instance }} has been unhealthy for more than 5 minutes."
          - alert: JivaAPIStatusNot200
            expr: probe_http_status_code{instance="https://jiva-sit.popclub.co.in/api/ext/v1/coins/txn"} != 200
            for: 1m
            labels:
              severity: critical
              service: jiva-api
              endpoint: coins-txn
            annotations:
              summary: "Jiva API coins/txn endpoint returned non-200 status"
              description: "The Jiva API endpoint https://jiva-sit.popclub.co.in/api/ext/v1/coins/txn returned status code {{ $value }} instead of 200. This may indicate an API issue."
      - name: CloudWatch Alerts
        rules:
          - alert: RDSLowStorage
            expr: aws_rds_free_storage_space_average < 30e9
            for: 1m
            labels:
              severity: critical
            annotations:
              summary: "RDS storage low for {{ $labels.dbinstance_identifier }}"
              description: "Free storage space < 30GB for 1m."
          - alert: RDSHighCPU
            expr: aws_rds_cpuutilization_average > 90
            for: 2m
            labels:
              severity: critical
            annotations:
              summary: "High CPU on RDS {{ $labels.dbinstance_identifier }}"
              description: "CPU utilization is above 90% for 2 minutes on {{ $labels.dbinstance_identifier }}."
          - alert: RDSHighConnections
            expr: aws_rds_database_connections_average > 3000
            for: 1m 
            labels:
              severity: critical
            annotations:
              summary: "High DB connections on {{ $labels.dbinstance_identifier }}"
              description: "Connections at {{ $value }} (80% of max) for RDS {{ $labels.dbinstance_identifier }}."
          - alert: HighWriteLatency
            expr: aws_rds_write_latency_average > 0.1
            for: 1m 
            labels:
              severity: critical
            annotations:
              summary: "High Write Latency {{ $labels.dbinstance_identifier }}"
              description: "High Write Latency for RDS {{ $labels.dbinstance_identifier }}."


#helm upgrade prometheus prometheus-community/prometheus -f values-zenduty-prod.yaml --namespace prometheus-pop-prod